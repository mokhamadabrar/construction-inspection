<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIP4n2uR2bM8r8ZlLkqGdZz4Vt3H1Z2b1bG6b0y7n5t7o8m9u3qfba7j0YwP2S7eCYbYcTgYJ/Z5x6z6x3wQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  /* ==== LANGUAGE STATE ==== */
  let currentLang = (localStorage.getItem('mhc_lang') === 'en') ? 'en' : 'id';
  const getLang = () => currentLang;

  /* ==== SCORING ==== */
  function scoreSection(sec){
    const names = new Set();
    sec.querySelectorAll('input[type=radio]').forEach(r=>names.add(r.name));
    let yes=0, denom=0;
    names.forEach(n=>{
      const chosen = sec.querySelector(`input[name="${n}"]:checked`);
      if(!chosen || chosen.value==='na') return;
      denom++; if(chosen.value==='yes') yes++;
    });
    return denom? Math.round(100*yes/denom):0;
  }
  function refreshScores(){
    const A = document.querySelector('tbody[data-section="A"]');
    const B = document.querySelector('tbody[data-section="B"]');
    const C = document.querySelector('tbody[data-section="C"]');
    const D = document.querySelector('tbody[data-section="D"]');
    const sA = scoreSection(A), sB = scoreSection(B), sC = scoreSection(C), sD = scoreSection(D);

    let yes=0, denom=0;
    [A,B,C,D].forEach(sec=>{
      const names = new Set();
      sec.querySelectorAll('input[type=radio]').forEach(r=>names.add(r.name));
      names.forEach(n=>{
        const chosen = sec.querySelector(`input[name="${n}"]:checked`);
        if(!chosen || chosen.value==='na') return;
        denom++; if(chosen.value==='yes') yes++;
      });
    });
    const total = denom? Math.round(100*yes/denom):0;

    document.getElementById('scoreA').textContent = sA + '%';
    document.getElementById('scoreB').textContent = sB + '%';
    document.getElementById('scoreC').textContent = sC + '%';
    document.getElementById('scoreD').textContent = sD + '%';
    document.getElementById('totalScore').textContent = total + '%';
    const badge = document.getElementById('badge');
    badge.textContent = `${total}/100`;
    badge.classList.remove('good','bad');
    badge.classList.add(total>=80 ? 'good' : 'bad');
  }
  document.querySelectorAll('#chkTable input[type=radio]').forEach(r=>r.addEventListener('change', refreshScores));
  refreshScores();

  /* ==== LIMIT HELPERS ==== */
  function enforceMaxWithAlert(el, MAX, fieldName){
    if(el.value.length > MAX){
      el.value = el.value.slice(0, MAX);
      const lang = getLang();
      const msg = lang==='en'
        ? `Maximum ${MAX} characters for ${fieldName}. Text has been truncated to meet the requirement.`
        : `Maksimal ${MAX} karakter untuk ${fieldName}. Teks telah dipotong agar sesuai ketentuan.`;
      alert(msg);
      return true;
    }
    return false;
  }

  /* ==== REMARKS (70) ==== */
  const MAX_REMARKS = 70;
  function updateCounter(area){
    const wrap = area.closest('.remarks-wrap');
    const counter = wrap.querySelector('.counter');
    const len = area.value.length;
    counter.textContent = `${len}/${MAX_REMARKS}`;
    counter.classList.toggle('limit', len >= MAX_REMARKS);
  }
  document.querySelectorAll('textarea.remarks').forEach(area=>{
    area.setAttribute('maxlength', String(MAX_REMARKS));
    updateCounter(area);
    area.addEventListener('input', e=>{
      enforceMaxWithAlert(e.target, MAX_REMARKS, getLang()==='en'?'Remarks':'Remarks');
      updateCounter(e.target);
    });
    area.addEventListener('paste', e=>{
      setTimeout(()=>{
        enforceMaxWithAlert(e.target, MAX_REMARKS, getLang()==='en'?'Remarks':'Remarks');
        updateCounter(e.target);
      },0);
    });
  });

  /* ==== PHOTOS (58) ==== */
  const MAX_DESC = 58;
  document.querySelectorAll('.photo-card input[type=file]').forEach(inp=>{
    inp.addEventListener('change', e=>{
      const file = e.target.files[0]; if(!file) return;
      const stage = e.target.closest('.photo-card').querySelector('.photo-stage');
      const img = document.createElement('img');
      const rd = new FileReader();
      rd.onload = ev=>{ stage.innerHTML=''; img.src = ev.target.result; stage.appendChild(img); };
      rd.readAsDataURL(file);
    });
  });
  document.querySelectorAll('.photo-card .photo-desc').forEach(desc=>{
    const printBox = desc.closest('.photo-card').querySelector('.photo-desc-print');
    const sync = ()=>{
      enforceMaxWithAlert(desc, MAX_DESC, getLang()==='en'?'Photo Description':'Deskripsi Foto');
      printBox.textContent = desc.value ? desc.value : '';
    };
    desc.setAttribute('maxlength', String(MAX_DESC));
    sync();
    desc.addEventListener('input', sync);
    desc.addEventListener('paste', ()=>setTimeout(sync,0));
  });

  /* ==== i18n ==== */
  function getQuestionMap(){
    const map = {};
    document.querySelectorAll('.chk-table tbody tr').forEach(tr=>{
      const no = tr.querySelector('.col-no');
      const q = tr.querySelector('.ques');
      if(no && q){ map[no.textContent.trim()] = q; }
    });
    return map;
  }
  const qMap = getQuestionMap();
  const baselineID = {}; Object.keys(qMap).forEach(k => baselineID[k] = qMap[k].textContent.trim());
  const i18n = {
    id: {
      labels: {
        label_site: "Site Assesssor",
        label_project: "Project",
        label_date: "Date",
        label_location: "Location",
        label_contractor: "Kontraktor",
        th_no: "No.", th_question: "Pertanyaan", th_yes: "YES", th_no2: "NO", th_na: "N/A",
        ph_assessor: "Nama Site Assesssor", ph_project: "Kode/Nama", ph_location: "Lokasi", ph_contractor: "Nama Kontraktor",
        ph_remarks: "Remarks (maks 70 karakter)…", ph_photo: "Deskripsi foto (maks 58)…",
        radio_yes: "Ya", radio_no: "Tidak", radio_na: "N/A"
      },
      questions: baselineID
    },
    en: {
      labels: {
        label_site: "Site Assessor",
        label_project: "Project",
        label_date: "Date",
        label_location: "Location",
        label_contractor: "Contractor",
        th_no: "No.", th_question: "Question", th_yes: "YES", th_no2: "NO", th_na: "N/A",
        ph_assessor: "Site assessor name", ph_project: "Code/Name", ph_location: "Location", ph_contractor: "Contractor name",
        ph_remarks: "Remarks (max 70 characters)…", ph_photo: "Photo description (max 58)…",
        radio_yes: "Yes", radio_no: "No", radio_na: "N/A"
      },
      questions: {
        A1:"Is the placement of materials compliant with the MSRA location and storage requirements?",
        A2:"Have the material weight/dimensions and movement method been discussed? (check the MSRA; plan vehicle route and consider load weight)",
        A3:"Does the material placement not obstruct pedestrians, provide access for picking, and are barricades provided?",
        A4:"Do you know the manual lifting limit is 18.14 kg per person, and loads longer than 3 m must be lifted by more than one person?",
        B5:"Whom do you report to if you need equipment to move your materials?",
        B6:"Have you checked that the handling/lifting equipment has been pre-use checklisted?",
        B7:"Do the handling/lifting equipment operators hold a valid license (SIO)?",
        C8:"Is the lifting equipment certification (SILO) available and valid?",
        C9:"Has the handling (lifting) equipment been inspected before being mobilized/used?",
        C10:"Have other auxiliary tools been inspected and declared fit for use?",
        C11:"Is the PPE in accordance with MSDS requirements?",
        D12:"Do you have waste bins for leftover materials to be disposed of?",
        D13:"Do you know the daily location of your waste collection points?",
        D14:"Do you clean before and after work and tidy up the tools?",
        D15:"If your materials are inside the building, do you provide floor protection and prevent dust generation?"
      }
    }
  };

  function setPlaceholders(lang){
    document.getElementById('inp-assessor').placeholder = i18n[lang].labels.ph_assessor;
    document.getElementById('inp-project').placeholder  = i18n[lang].labels.ph_project;
    document.getElementById('inp-location').placeholder = i18n[lang].labels.ph_location;
    document.getElementById('inp-contractor').placeholder = i18n[lang].labels.ph_contractor;
    document.querySelectorAll('textarea.remarks').forEach(t=> t.placeholder = i18n[lang].labels.ph_remarks);
    document.querySelectorAll('.photo-desc').forEach(p=> p.placeholder = i18n[lang].labels.ph_photo);
  }
  function setLabels(lang){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const txt = i18n[lang].labels[key];
      if(txt) el.textContent = txt;
    });
  }
  function setRadioLabels(lang){
    const yesTxt = i18n[lang].labels.radio_yes;
    const noTxt  = i18n[lang].labels.radio_no;
    const naTxt  = i18n[lang].labels.radio_na;
    document.querySelectorAll('.yn label').forEach(lab=>{
      const inp = lab.querySelector('input');
      if(!inp) return;
      let txt = naTxt;
      if(inp.value==='yes') txt = yesTxt;
      else if(inp.value==='no') txt = noTxt;
      let textNode = Array.from(lab.childNodes).find(n=> n.nodeType===Node.TEXT_NODE);
      if(textNode){ textNode.nodeValue = ' ' + txt; }
      else{ lab.appendChild(document.createTextNode(' ' + txt)); }
    });
  }
  function setQuestions(lang){
    const dict = i18n[lang].questions;
    Object.keys(qMap).forEach(key=>{
      const el = qMap[key];
      el.textContent = dict[key] || baselineID[key];
    });
  }
  function applyLanguage(lang){
    currentLang = (lang==='en') ? 'en' : 'id';
    setLabels(currentLang); setPlaceholders(currentLang); setQuestions(currentLang); setRadioLabels(currentLang);
    localStorage.setItem('mhc_lang', currentLang);
    document.getElementById('btnID').setAttribute('aria-pressed', currentLang==='id' ? 'true' : 'false');
    document.getElementById('btnEN').setAttribute('aria-pressed', currentLang==='en' ? 'true' : 'false');
  }
  applyLanguage(getLang());
  document.getElementById('btnID').addEventListener('click', ()=>applyLanguage('id'));
  document.getElementById('btnEN').addEventListener('click', ()=>applyLanguage('en'));

  /* ==== PRINT & RESET ==== */
  document.getElementById('printBtn').addEventListener('click', ()=>window.print());
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    document.querySelectorAll('#chkTable input[type=radio]').forEach(r=>r.checked=false);
    document.querySelectorAll('.remarks').forEach(t=>{ t.value=''; updateCounter(t); });
    document.querySelectorAll('.photo-card').forEach(card=>{
      card.querySelector('.photo-stage').innerHTML='<span>Tambahkan Foto</span>';
      const f = card.querySelector('input[type=file]'); if(f) f.value='';
      const d = card.querySelector('.photo-desc'); if(d){ d.value=''; }
      const pb = card.querySelector('.photo-desc-print'); if(pb){ pb.textContent=''; }
    });
    refreshScores(); window.scrollTo({top:0,behavior:'smooth'});
  });

  /* ==== PDF BUILDER (lebih kompatibel) ==== */
  function filenameFromMeta(){
    const project = (document.getElementById('inp-project').value || 'PROJECT').trim().replace(/\s+/g,'_');
    const date = (document.getElementById('inp-date').value || new Date().toISOString().slice(0,10));
    return `MHC_${project}_${date}.pdf`;
  }
  function expandRemarksForExport(){
    const areas = Array.from(document.querySelectorAll('textarea.remarks'));
    const original = [];
    areas.forEach(a=>{
      original.push([a, a.style.height, a.style.overflow]);
      a.style.height = 'auto';
      a.style.overflow = 'visible';
      a.style.height = a.scrollHeight + 'px';
    });
    return ()=>{ original.forEach(([a,h,o])=>{ a.style.height = h || ''; a.style.overflow = o || ''; }); };
  }
  async function buildPdfBlobSafe(){
    const el = document.querySelector('.page');
    const opt = {
      margin:       [10,10,10,10],
      image:        { type:'jpeg', quality:0.92 },
      html2canvas:  { scale: 2, useCORS:true, allowTaint:true, background:'#ffffff' },
      jsPDF:        { unit:'mm', format:'a4', orientation:'portrait' },
      pagebreak:    { mode: ['css','legacy'] }
    };
    const toolbar = document.querySelector('.toolbar');
    const logo = document.querySelector('.logo-wrap img');
    const restoreRemarks = expandRemarksForExport();
    const prevToolbarVis = toolbar.style.visibility;
    toolbar.style.visibility = 'hidden';

    try{
      // Gunakan pipeline yang paling stabil: toPdf().get('pdf')
      const worker = html2pdf().set(opt).from(el).toPdf();
      const pdf = await worker.get('pdf');
      const blob = pdf.output('blob'); // Blob PDF
      return blob;
    }catch(err1){
      // Jika ada isu CORS gambar, coba sembunyikan logo lalu ulang
      try{
        if(logo) logo.style.visibility = 'hidden';
        const worker = html2pdf().set(opt).from(el).toPdf();
        const pdf = await worker.get('pdf');
        const blob = pdf.output('blob');
        return blob;
      }finally{
        if(logo) logo.style.visibility = '';
      }
    }finally{
      restoreRemarks();
      toolbar.style.visibility = prevToolbarVis || '';
    }
  }

  /* ==== WHATSAPP SHARE (maksimal otomatis yang diizinkan) ==== */
  async function shareViaWhatsApp(){
    // upayakan tetap dalam "user gesture"
    const btn = document.getElementById('waBtn');
    const oldHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = (getLang()==='en' ? 'Preparing PDF…' : 'Menyiapkan PDF…');

    try{
      // 1) Buat PDF
      const blob = await buildPdfBlobSafe();
      const file = new File([blob], filenameFromMeta(), { type:'application/pdf', lastModified: Date.now() });

      // 2) Share API dengan file (Android Chrome/Edge biasanya OK)
      if(navigator.canShare && navigator.canShare({ files:[file] })){
        btn.innerHTML = (getLang()==='en' ? 'Opening WhatsApp…' : 'Membuka WhatsApp…');
        await navigator.share({
          files:[file],
          title:'Material Handling Checklist',
          text:(getLang()==='en' ? 'Material Handling Checklist (PDF attached).' : 'Material Handling Checklist (PDF terlampir).')
        });
        // selesai; WhatsApp akan terbuka dengan PDF terlampir
        return;
      }

      // 3) Fallback: unduh & buka WhatsApp/WA Web dengan pesan
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filenameFromMeta(); a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 60000);

      const msgID = 'PDF telah diunduh. Silakan lampirkan file tersebut di WhatsApp.';
      const msgEN = 'PDF downloaded. Please attach the file in WhatsApp.';
      const message = encodeURIComponent(getLang()==='en'? msgEN : msgID);
      // Prioritas ke aplikasi WhatsApp jika ada; jika tidak, WA Web
      const waUrl = /Android/i.test(navigator.userAgent)
        ? 'https://wa.me/?text=' + message
        : 'https://web.whatsapp.com/send?text=' + message;
      window.open(waUrl, '_blank');

      alert(getLang()==='en'
        ? 'Your browser cannot attach files directly to WhatsApp. The PDF has been downloaded—attach it from your Files.'
        : 'Browser Anda tidak bisa melampirkan file langsung ke WhatsApp. PDF sudah diunduh—lampirkan dari Files.');
    }catch(err){
      console.error(err);
      alert(getLang()==='en'
        ? 'Failed to generate or share the PDF. Try again, or use Print to save as PDF then share manually.'
        : 'Gagal membuat atau membagikan PDF. Coba lagi, atau gunakan Print untuk simpan PDF lalu bagikan manual.');
    }finally{
      btn.innerHTML = oldHTML;
      btn.disabled = false;
    }
  }

  // Tombol
  document.getElementById('printBtn').addEventListener('click', ()=>window.print());
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    document.querySelectorAll('#chkTable input[type=radio]').forEach(r=>r.checked=false);
    document.querySelectorAll('.remarks').forEach(t=>{ t.value=''; updateCounter(t); });
    document.querySelectorAll('.photo-card').forEach(card=>{
      card.querySelector('.photo-stage').innerHTML='<span>Tambahkan Foto</span>';
      const f = card.querySelector('input[type=file]'); if(f) f.value='';
      const d = card.querySelector('.photo-desc'); if(d){ d.value=''; }
      const pb = card.querySelector('.photo-desc-print'); if(pb){ pb.textContent=''; }
    });
    refreshScores(); window.scrollTo({top:0,behavior:'smooth'});
  });
  document.getElementById('waBtn').addEventListener('click', ()=>{ shareViaWhatsApp(); });
</script>
